---
title: "Teenage Conceptions in Greater Manchester"
author: "Rhian Davies"
date: "17/02/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

## Introduction

We have perfomed an analysis of the ONS conceptions data, available online at ..
```{r cars}
library("tidyverse")
df = read_csv(file = "../data/processed/conception_table_6.csv")
```


```{r pressure, echo=FALSE}
df %>%
  filter(stat == "conceptions_per_100") %>%
  filter(Area != "ENGLAND") %>%
  mutate(is_total = (Area == "NORTH WEST")) %>%
  ggplot(aes(x = year, y = value)) + 
  geom_point(aes(col = is_total)) + 
  geom_line(aes(group = Area, col = is_total)) + 
  scale_color_manual(values = c("grey", "purple")) +
  theme(legend.position = "none") +
  ggtitle("Conceptions per 100 teenagers") 
```

```{r}
df %>%
  filter(stat == "conceptions_per_100") %>%
  filter(Area != "NORTH WEST") %>%
  filter(Area != "ENGLAND") %>%
  filter(year == 2017) %>%
  ggplot(aes(x =  reorder(Area, value), y = value)) + 
  geom_col() + 
  coord_flip() + 
  ggtitle("Conceptions per 1000 teenages in the Greater Manchester, split by LSOA") + 
  theme_minimal() + 
  ylab("") +
  xlab("")

df %>%
  filter(stat != "number_conceptions") %>%
  ggplot(aes(x = year, y = value)) + 
  geom_point(aes(col = Area)) + 
  geom_line(aes(group = Area)) + 
  facet_wrap(~stat)
```

# Creating maps

It makes sense to represent some of this data on a map.
In order to do this, we need a shapefile of Greater Manchester. 
We've downloaded the Local Authority Districts shape file from the [Open Geography Portal](http://geoportal.statistics.gov.uk/)

```{r}
library("sf")
geo = st_read("../data/raw/Local_Authority_Districts_December_2019_Boundaries_UK_BFC/Local_Authority_Districts_December_2019_Boundaries_UK_BFC.shp")

# Keep only GM data
lsoa_codes = c("E08000001", "E08000002", "E08000003", "E08000004", "E08000005",
               "E08000006", "E08000007", "E08000008", "E08000009", "E08000010",
               "E11000001", "E12000002", "E92000001")

geo_gm =
  geo %>%
  filter(lad19cd %in% lsoa_codes)
```

```{r}
teen_17 = 
  df %>%
  filter(year == 2017) %>%
  filter(stat == "conceptions_per_100")

teen_17_geo = 
  left_join(geo_gm, teen_17, by = c("lad19cd" = "LSOA"))
# Tmap
library("tmap")
tm_shape(teen_17_geo) +
  tm_polygons(col = "value", palette="Purples", title = "Teenager conceptions \n per 100") + 
  tm_text("Area", size = 0.7, col = "black")

```

# Leaflet map

We then dediced to create a interactive map, using the same dataset above, but instead using the **leaflet** package.

In order to colour the polygons by the values, we had to first create our own palette function.
We then used that palette function in the fillColor argument.

```{r leafletmap}
library("leaflet")

pal = colorNumeric(palette = "Purples", domain = teen_17_geo$values)

teen_17_geo %>%
  st_transform(4326) %>%
  leaflet() %>%
  addTiles() %>%
  addPolygons(fillColor = ~pal(value),
              label = ~Area, 
              weight = 2,
              opacity = 1,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.8) %>%
    addLegend("bottomleft", pal = pal, values = ~value,
    title = "Conceptions per </br>1000 teenagers")
```

